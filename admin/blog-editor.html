<script data-cfasync="false">
/* =========================
   CONFIG
========================= */
const N8N_GROQ_WEBHOOK = window.ENV?.N8N_GROQ_WEBHOOK || '';
const N8N_PUBLISH_WEBHOOK = window.ENV?.N8N_PUBLISH_WEBHOOK || '';
const AFFILIATE_LINKS = window.AFFILIATE_LINKS || {};

/* =========================
   STATE
========================= */
let tags = [];
let currentTab = 0;
let selectedAffiliateLinks = [];
let insertedAffiliateLinks = [];

/* =========================
   INIT
========================= */
document.addEventListener('DOMContentLoaded', () => {
  setupTagInput();
  setupCounters();
  setupFormSubmit();
  setupAffiliateLinks();
  restoreDraft();
  updatePreview();
});

/* =========================
   UI HELPERS
========================= */
function showMessage(text, type = 'info') {
  const el = document.getElementById('statusMessage');
  el.className = `status-message ${type}`;
  el.textContent = text;
  el.style.display = 'block';
}

function switchTab(index) {
  document.querySelectorAll('.tab').forEach((t, i) =>
    t.classList.toggle('active', i === index)
  );
  document.querySelectorAll('.tab-content').forEach((c, i) =>
    c.classList.toggle('active', i === index)
  );
  currentTab = index;
  if (index === 3) updatePreview();
}

/* =========================
   FORM SUBMIT
========================= */
function setupFormSubmit() {
  document.getElementById('blogForm').addEventListener('submit', async e => {
    e.preventDefault();

    showMessage('üöÄ Publishing post...', 'info');

    const payload = {
      title: title.value,
      content: content.value,
      category: category.value,
      tags,
      seoTitle: seoTitle.value,
      seoDescription: seoDescription.value,
      authorName: authorName.value,
      authorRole: authorRole.value,
      affiliateLinks: insertedAffiliateLinks,
      createdAt: new Date().toISOString()
    };

    try {
      const res = await fetch(N8N_PUBLISH_WEBHOOK, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error(await res.text());
      localStorage.removeItem('wgd_draft');

      showMessage('‚úÖ Post published successfully!', 'success');
    } catch (err) {
      showMessage(`‚ùå Publish failed: ${err.message}`, 'error');
    }
  });
}

/* =========================
   DRAFTS
========================= */
function saveDraft() {
  const draft = {
    title: title.value,
    content: content.value,
    category: category.value,
    tags,
    seoTitle: seoTitle.value,
    seoDescription: seoDescription.value,
    authorName: authorName.value,
    authorRole: authorRole.value
  };
  localStorage.setItem('wgd_draft', JSON.stringify(draft));
  showMessage('üíæ Draft saved locally', 'success');
}

function restoreDraft() {
  const raw = localStorage.getItem('wgd_draft');
  if (!raw) return;
  const d = JSON.parse(raw);
  title.value = d.title || '';
  content.value = d.content || '';
  category.value = d.category || '';
  tags = d.tags || [];
  seoTitle.value = d.seoTitle || '';
  seoDescription.value = d.seoDescription || '';
  authorName.value = d.authorName || '';
  authorRole.value = d.authorRole || '';
  renderTags();
}

/* =========================
   GROQ VIA N8N
========================= */
async function callGroqViaWebhook(prompt) {
  const res = await fetch(N8N_GROQ_WEBHOOK, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt })
  });

  const text = await res.text();
  if (!res.ok) throw new Error(text);

  try {
    const json = JSON.parse(text);
    if (Array.isArray(json) && json[0]?.content) return json[0].content;
    if (json.content) return json.content;
    return text;
  } catch {
    return text;
  }
}

/* =========================
   AI FUNCTIONS
========================= */
async function generateAIContent() {
  if (!aiTopic.value || !category.value)
    return showMessage('Topic and category required', 'error');

  showMessage('ü§ñ Generating content...', 'info');

  try {
    const result = await callGroqViaWebhook(`
Write a 1500‚Äì2000 word markdown blog post about:
${aiTopic.value}
Category: ${category.value}
`);

    content.value = result;
    title.value = aiTopic.value;
    updateCountersAll();

    showMessage('‚úÖ Content generated', 'success');
  } catch (e) {
    showMessage(e.message, 'error');
  }
}

async function aiImprove(event) {
  const btn = event.currentTarget;
  btn.disabled = true;

  try {
    content.value = await callGroqViaWebhook(
      `Improve this content:\n${content.value}`
    );
    updateCountersAll();
    showMessage('‚ú® Content improved', 'success');
  } catch (e) {
    showMessage(e.message, 'error');
  } finally {
    btn.disabled = false;
  }
}

async function aiSEO() {
  showMessage('ü§ñ Generating SEO...', 'info');

  const response = await callGroqViaWebhook(`
Return JSON:
{
 "seoTitle": "...",
 "metaDescription": "..."
}
For:
${title.value}
${content.value.slice(0, 500)}
`);

  const parsed = JSON.parse(response);
  seoTitle.value = parsed.seoTitle;
  seoDescription.value = parsed.metaDescription;
  updateGooglePreview();
}

/* =========================
   PREVIEW (MARKDOWN ‚Üí HTML)
========================= */
function updatePreview() {
  let html = content.value
    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
    .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
    .replace(/\n/gim, '<br>');

  previewContent.innerHTML = html || '<p>No content yet</p>';
}

/* =========================
   TAGS
========================= */
function setupTagInput() {
  tagInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      if (tagInput.value && !tags.includes(tagInput.value)) {
        tags.push(tagInput.value);
        tagInput.value = '';
        renderTags();
      }
    }
  });
}

function renderTags() {
  tagsContainer.innerHTML =
    tags.map((t, i) =>
      `<div class="tag">${t}<button onclick="removeTag(${i})">√ó</button></div>`
    ).join('') + tagInput.outerHTML;
  setupTagInput();
}

function removeTag(i) {
  tags.splice(i, 1);
  renderTags();
}

/* =========================
   SEO CHECK
========================= */
function checkSEO() {
  updateQualityScore();
  showMessage('üìä SEO checked', 'success');
}

function updateCountersAll() {
  updateWordCount();
  updateTitleCounter();
  updateQualityScore();
}
</script>
